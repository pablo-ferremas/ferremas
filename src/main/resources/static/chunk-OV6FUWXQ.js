import{Ca as f,Ka as D,O as i,T as o,bc as c,dc as S,k as v,n as h,r as p,z as C}from"./chunk-TVOLU7LP.js";var n=class r{constructor(e){this.http=e}baseUrl=`${S.apiUrl}`;getTasasCambio(){return this.http.get(`${this.baseUrl}/tasas`)}static \u0275fac=function(t){return new(t||r)(o(c))};static \u0275prov=i({token:r,factory:r.\u0275fac,providedIn:"root"})};var l=class r{constructor(e,t){this.http=e;this.tasaService=t;console.log("\u{1F680} DivisaService inicializado"),this.loadRates()}selectedDivisaSubject=new v("CLP");ratesSubject=new v([{code:"CLP",name:"Peso Chileno",rate:1}]);selectedDivisa$=this.selectedDivisaSubject.asObservable();rates$=this.ratesSubject.asObservable();CACHE_KEY="ferremas_tasas_cambio";loadRates(){console.log("Iniciando carga de tasas...");let e=this.getCachedRates();if(e){console.log("Usando tasas desde localStorage:",e),this.ratesSubject.next(e);return}console.log("Cargando tasas desde backend..."),this.loadFromBackend()}loadFromBackend(){console.log("\u{1F504} Iniciando carga desde backend..."),this.tasaService.getTasasCambio().pipe(p(e=>{console.log("\u2705 Respuesta RAW del backend:",e),console.log("\u{1F50D} Tipo de respuesta:",typeof e),console.log("\u{1F50D} Es array:",Array.isArray(e)),console.log("\u{1F50D} Longitud del array:",e?.length),Array.isArray(e)&&e.length>0&&console.log("\u{1F50D} Primer elemento:",e[0]);let t=this.mapBackendResponseToRates(e);return console.log("\u{1F4CA} Tasas mapeadas:",t),t}),C(e=>(console.error("\u274C ERROR en getTasasCambio():"),console.error("\u{1F50D} Error status:",e?.status),console.error("\u{1F50D} Error message:",e?.message),console.error("\u{1F50D} Error completo:",e),e?.status===0&&console.error("\u{1F6AB} Posible error de CORS o servidor no disponible"),h(this.getDefaultRates())))).subscribe({next:e=>{console.log("\u{1F4BE} Guardando tasas:",e),this.saveTasasToCache(e),this.ratesSubject.next(e),console.log("\u2705 Proceso completado exitosamente")},error:e=>{console.error("\u274C Error en subscribe:",e)}})}getCachedRates(){try{let e=localStorage.getItem(this.CACHE_KEY);if(!e)return console.log("\u{1F4ED} No hay tasas en cache"),null;let t=JSON.parse(e);return this.isCacheValid(t.timestamp)?(console.log("Cache v\xE1lido, tasas del d\xEDa actual"),t.tasas):(console.log("Cache expirado, necesita renovaci\xF3n"),localStorage.removeItem(this.CACHE_KEY),null)}catch(e){return console.error("Error leyendo cache:",e),localStorage.removeItem(this.CACHE_KEY),null}}isCacheValid(e){try{let t=new Date(e),a=new Date,s=t.getFullYear()===a.getFullYear()&&t.getMonth()===a.getMonth()&&t.getDate()===a.getDate();return console.log(`Fecha cache: ${t.toDateString()}, Hoy: ${a.toDateString()}, V\xE1lido: ${s}`),s}catch(t){return console.error("Error validando fecha del cache:",t),!1}}saveTasasToCache(e){try{let t={tasas:e,timestamp:new Date().toISOString()};localStorage.setItem(this.CACHE_KEY,JSON.stringify(t)),console.log("Tasas guardadas en localStorage")}catch(t){console.error("Error guardando tasas en cache:",t)}}mapBackendResponseToRates(e){let t=[{code:"CLP",name:"Peso Chileno",rate:1}];return e.forEach(a=>{let s=this.getDivisaName(a.currency);t.push({code:a.currency,name:s,rate:a.rate})}),console.log("Tasas procesadas:",t),t}getDivisaName(e){return{USD:"D\xF3lar",EUR:"Euro",CLP:"Peso Chileno"}[e]||e}getDefaultRates(){let e=[{code:"CLP",name:"Peso Chileno",rate:1},{code:"USD",name:"D\xF3lar",rate:950},{code:"EUR",name:"Euro",rate:1050}];return console.warn("Usando tasas por defecto:",e),e}refreshRates(){console.log("Refrescando tasas manualmente..."),localStorage.removeItem(this.CACHE_KEY),this.loadFromBackend()}clearCache(){localStorage.removeItem(this.CACHE_KEY),console.log("Cache de tasas limpiado")}hasCachedRates(){let e=localStorage.getItem(this.CACHE_KEY);if(!e)return!1;try{let t=JSON.parse(e);return this.isCacheValid(t.timestamp)}catch{return!1}}getLastCacheDate(){try{let e=localStorage.getItem(this.CACHE_KEY);if(!e)return null;let t=JSON.parse(e);return new Date(t.timestamp)}catch{return null}}getCurrentRates(){return this.ratesSubject.value}setSelectedDivisa(e){this.selectedDivisaSubject.next(e)}getSelectedDivisa(){return this.selectedDivisaSubject.value}convertPrice(e,t="CLP",a){let s=a||this.getSelectedDivisa(),m=this.ratesSubject.value;if(t===s)return e;let d=m.find(u=>u.code===t)?.rate||1,g=m.find(u=>u.code===s)?.rate||1;return t==="CLP"?e/g:s==="CLP"?e*d:e*d/g}formatPrice(e,t="CLP"){let a=this.convertPrice(e,t);switch(this.getSelectedDivisa()){case"USD":return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0}).format(a);case"EUR":return new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR",minimumFractionDigits:0}).format(a);case"CLP":default:return new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",minimumFractionDigits:0}).format(a)}}static \u0275fac=function(t){return new(t||r)(o(c),o(n))};static \u0275prov=i({token:r,factory:r.\u0275fac,providedIn:"root"})};var y=class r{constructor(e){this.divisaService=e}transform(e,t="CLP"){let a=this.divisaService.convertPrice(e,t);switch(this.divisaService.getSelectedDivisa()){case"USD":return`USD$ ${new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format(a)}`;case"EUR":return new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR",minimumFractionDigits:0}).format(a);case"CLP":default:return`CLP$ ${new Intl.NumberFormat("es-CL",{minimumFractionDigits:0,maximumFractionDigits:0}).format(a)}`}}static \u0275fac=function(t){return new(t||r)(f(l,16))};static \u0275pipe=D({name:"conversor",type:r,pure:!1})};export{l as a,y as b};
