import{a as Te,b as te}from"./chunk-FTKAUQPB.js";import{d as W,i as L,j as ye}from"./chunk-SZIRPOAJ.js";import{a as z,b as q,c as H,d as G,e as $,f as Y,g as Pe,h as Me,i as J,j as K,k as Z,l as we,m as Ee,n as Q,p as Ie,q as X}from"./chunk-QVTE7ZQO.js";import{a as Oe}from"./chunk-I2XG45E3.js";import{b as ee}from"./chunk-OV6FUWXQ.js";import{$ as u,Ca as w,Ha as D,Ma as f,O,Sa as _e,Sb as xe,T as k,Ta as m,Tb as V,Ua as fe,Ub as be,Va as Ce,Vb as Se,Wb as B,Xa as i,Ya as o,Za as C,_ as p,a as ce,aa as ue,ab as S,b as le,bb as _,bc as j,cb as s,d as se,dc as F,e as N,ga as ge,ib as n,jb as g,k as de,kb as y,lb as ae,mb as ve,n as me,nb as he,pb as v,qb as h,r as E,rb as x,va as U,wb as b,xb as M,ya as c,yb as A,z as pe}from"./chunk-TVOLU7LP.js";function Ue(r,t){r&1&&(ue(),i(0,"svg",17),C(1,"rect",18),i(2,"text",19),n(3,"Sin imagen"),o()())}function je(r,t){r&1&&(i(0,"span",20),n(1,"Agotado"),o())}function We(r,t){r&1&&(i(0,"span",21),n(1," \xDAltima unidad "),o())}function Fe(r,t){if(r&1&&(i(0,"span",21),n(1),o()),r&2){let e=s(2);c(),y(" \xDAltimas ",e.producto.stock," unidades ")}}function Le(r,t){if(r&1&&(i(0,"span",22),n(1),o()),r&2){let e=s(2);c(),y(" Stock: ",e.producto.stock," unidades ")}}function ze(r,t){if(r&1&&(i(0,"span",20),n(1),o()),r&2){let e=s(2);c(),y("-",e.producto.descuento,"%")}}function qe(r,t){if(r&1){let e=S();i(0,"div",1)(1,"h6",2),n(2),o(),i(3,"div",3),C(4,"img",4),o(),f(5,Ue,4,0,"svg",5),i(6,"div",6)(7,"p",7),n(8),o(),i(9,"div",8),f(10,je,2,0,"span",9)(11,We,2,0,"span",10)(12,Fe,2,1,"span",10)(13,Le,2,1,"span",11),o(),i(14,"div",12)(15,"strong",13),n(16),b(17,"conversor"),o(),f(18,ze,2,1,"span",9),o()(),i(19,"div",14)(20,"button",15),_("click",function(){p(e);let a=s();return u(a.onAgregarAlCarrito())}),n(21," Agregar al Carro "),o(),i(22,"button",16),_("click",function(){p(e);let a=s();return u(a.onMostrar())}),n(23," Comprar "),o()()()}if(r&2){let e=s();Ce("agotado",e.producto.stock===0),c(2),g(e.producto.nombre),c(2),m("src",e.producto.imagen||"assets/images/placeholder-producto.jpg",U)("alt",e.producto.nombre),c(),m("ngIf",!e.producto.imagen),c(3),g(e.producto.descripcion),c(2),m("ngIf",e.producto.stock===0),c(),m("ngIf",e.producto.stock===1),c(),m("ngIf",e.producto.stock>1&&e.producto.stock<=5),c(),m("ngIf",e.producto.stock>5),c(3),g(M(17,15,e.getPrecioActual())),c(2),m("ngIf",e.producto.descuento),c(2),m("disabled",e.producto.stock===0),c(2),m("disabled",e.producto.stock===0)}}var ke=class r{constructor(t,e){this.compraService=t;this.carritoService=e}producto;onMostrar(){this.producto.stock>0&&this.compraService.iniciarCompra(this.producto)}onAgregarAlCarrito(){this.producto.stock>0&&(this.carritoService.agregarProducto(this.producto,1),this.mostrarNotificacion())}getPrecioActual(){return!this.producto.precios||this.producto.precios.length===0?0:this.producto.precios[0].precio}tieneDescuento(){return this.producto.descuento>0}estaAgotado(){return this.producto.stock===0}pocasUnidades(){return this.producto.stock>0&&this.producto.stock<=5}getStock(){return this.producto.stock||0}mostrarNotificacion(){let t=document.createElement("div");t.className="alert alert-success toast-notification",t.innerHTML=`
    <i class="fas fa-check-circle me-2"></i>
    Producto agregado al carrito
  `,document.body.appendChild(t),setTimeout(()=>{t.classList.add("show")},10),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>{t.parentNode&&document.body.removeChild(t)},300)},1e3)}static \u0275fac=function(e){return new(e||r)(w(te),w(L))};static \u0275cmp=D({type:r,selectors:[["app-card"]],inputs:{producto:"producto"},decls:1,vars:1,consts:[["class","card mb-3 h-100 d-flex flex-column",3,"agotado",4,"ngIf"],[1,"card","mb-3","h-100","d-flex","flex-column"],[1,"card-header"],[1,"image-container"],["width","100%","height","200",1,"card-img-top","product-image",2,"object-fit","contain",3,"src","alt"],["xmlns","http://www.w3.org/2000/svg","class","d-block user-select-none","width","100%","height","200","aria-label","Placeholder: Image cap","focusable","false","role","img","preserveAspectRatio","xMidYMid slice","viewBox","0 0 318 180","style","font-size:1.125rem;text-anchor:middle",4,"ngIf"],[1,"card-body","d-flex","flex-column"],[1,"card-text",2,"height","70px","overflow","hidden"],[1,"stock-info","mb-2"],["class","badge bg-danger",4,"ngIf"],["class","badge bg-warning-red",4,"ngIf"],["class","text-muted small",4,"ngIf"],[1,"d-flex","justify-content-between","align-items-center","mt-auto"],[1,"text-primary"],[1,"card-footer","d-flex","justify-content-between"],["type","button",1,"btn","btn-outline-primary","btn-sm",3,"click","disabled"],["type","button","data-bs-toggle","modal","data-bs-target","#modalCompra",1,"btn","btn-success","btn-sm",3,"click","disabled"],["xmlns","http://www.w3.org/2000/svg","width","100%","height","200","aria-label","Placeholder: Image cap","focusable","false","role","img","preserveAspectRatio","xMidYMid slice","viewBox","0 0 318 180",1,"d-block","user-select-none",2,"font-size","1.125rem","text-anchor","middle"],["width","100%","height","100%","fill","#868e96"],["x","50%","y","50%","fill","#dee2e6","dy",".3em"],[1,"badge","bg-danger"],[1,"badge","bg-warning-red"],[1,"text-muted","small"]],template:function(e,l){e&1&&f(0,qe,24,17,"div",0),e&2&&m("ngIf",!l.producto.oculto)},dependencies:[B,V,ee],styles:[".card-header[_ngcontent-%COMP%]{height:60px;display:flex;align-items:center;overflow:hidden}.card-header[_ngcontent-%COMP%]   h6[_ngcontent-%COMP%]{margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}.card.agotado[_ngcontent-%COMP%]{filter:grayscale(100%);opacity:.7}.card.agotado[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{filter:grayscale(100%)}.card.agotado[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%], .card.agotado[_ngcontent-%COMP%]   .card-header[_ngcontent-%COMP%], .card.agotado[_ngcontent-%COMP%]   .card-footer[_ngcontent-%COMP%]{color:#6c757d}.stock-info[_ngcontent-%COMP%]{display:flex;align-items:center}.stock-info[_ngcontent-%COMP%]   .badge[_ngcontent-%COMP%]{font-size:.75rem}.badge.bg-warning-red[_ngcontent-%COMP%]{background-color:#dc3545cc!important;color:#fff!important;border:1px solid rgba(220,53,69,.3)}.btn[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}"]})};var ie=se(Te());function $e(r,t){if(r&1){let e=S();i(0,"div",8)(1,"div",9)(2,"div",10)(3,"h6")(4,"strong"),n(5,"Resumen de compra"),o()(),i(6,"p",11),n(7,"Orden: "),i(8,"strong"),n(9),o()(),i(10,"p",11),n(11,"Monto: "),i(12,"strong",12),n(13),b(14,"number"),o()(),i(15,"p",13),n(16,"Comercio: "),i(17,"strong"),n(18,"Ferremas SpA"),o()()(),i(19,"div",10)(20,"div",14)(21,"div",15),C(22,"i",16),i(23,"small"),n(24,"Conexi\xF3n segura SSL"),o()(),i(25,"div",17),C(26,"i",18),i(27,"small"),n(28,"Transacci\xF3n protegida"),o()()()()(),i(29,"form",19),_("ngSubmit",function(){p(e);let a=s();return u(a.iniciarPago())}),i(30,"div",20)(31,"div",21)(32,"label",22),n(33,"N\xFAmero de tarjeta *"),o(),i(34,"input",23),x("ngModelChange",function(a){p(e);let d=s();return h(d.numeroTarjeta,a)||(d.numeroTarjeta=a),u(a)}),_("input",function(){p(e);let a=s();return u(a.formatearTarjeta())}),o()(),i(35,"div",21)(36,"label",24),n(37,"Nombre del titular *"),o(),i(38,"input",25),x("ngModelChange",function(a){p(e);let d=s();return h(d.nombreTitular,a)||(d.nombreTitular=a),u(a)}),o()()(),i(39,"div",20)(40,"div",26)(41,"label",27),n(42,"Mes *"),o(),i(43,"select",28),x("ngModelChange",function(a){p(e);let d=s();return h(d.mesExpiracion,a)||(d.mesExpiracion=a),u(a)}),i(44,"option",29),n(45,"MM"),o(),i(46,"option",30),n(47,"01"),o(),i(48,"option",31),n(49,"02"),o(),i(50,"option",32),n(51,"03"),o(),i(52,"option",33),n(53,"04"),o(),i(54,"option",34),n(55,"05"),o(),i(56,"option",35),n(57,"06"),o(),i(58,"option",36),n(59,"07"),o(),i(60,"option",37),n(61,"08"),o(),i(62,"option",38),n(63,"09"),o(),i(64,"option",39),n(65,"10"),o(),i(66,"option",40),n(67,"11"),o(),i(68,"option",41),n(69,"12"),o()()(),i(70,"div",26)(71,"label",42),n(72,"A\xF1o *"),o(),i(73,"select",43),x("ngModelChange",function(a){p(e);let d=s();return h(d.anoExpiracion,a)||(d.anoExpiracion=a),u(a)}),i(74,"option",29),n(75,"AAAA"),o(),i(76,"option",44),n(77,"2024"),o(),i(78,"option",45),n(79,"2025"),o(),i(80,"option",46),n(81,"2026"),o(),i(82,"option",47),n(83,"2027"),o(),i(84,"option",48),n(85,"2028"),o(),i(86,"option",49),n(87,"2029"),o()()(),i(88,"div",26)(89,"label",50),n(90,"CVV *"),o(),i(91,"input",51),x("ngModelChange",function(a){p(e);let d=s();return h(d.cvv,a)||(d.cvv=a),u(a)}),o()()(),i(92,"div",52)(93,"button",53),_("click",function(){p(e);let a=s();return u(a.cancelarPago())}),n(94," Cancelar "),o(),i(95,"button",54),C(96,"i",55),n(97),b(98,"number"),o()()()()}if(r&2){let e=s();c(9),g(e.numeroOrden),c(4),y("$",A(14,8,e.monto,"1.0-0"),""),c(21),v("ngModel",e.numeroTarjeta),c(4),v("ngModel",e.nombreTitular),c(5),v("ngModel",e.mesExpiracion),c(30),v("ngModel",e.anoExpiracion),c(18),v("ngModel",e.cvv),c(6),y(" Pagar $",A(98,11,e.monto,"1.0-0")," ")}}function Ye(r,t){if(r&1){let e=S();i(0,"div",56)(1,"div",57)(2,"span",58),n(3,"Procesando..."),o()(),i(4,"h5"),n(5,"Procesando pago..."),o(),i(6,"p"),n(7),o(),i(8,"div",59)(9,"div",60),n(10),o()(),i(11,"button",61),_("click",function(){p(e);let a=s();return u(a.cancelarPago())}),n(12," Cancelar Pago "),o()()}if(r&2){let e=s();c(7),y("Tiempo restante: ",e.tiempoRestante," segundos"),c(2),fe("width",e.progreso,"%"),_e("aria-valuenow",e.progreso),c(),y(" ",e.progreso,"% ")}}function Je(r,t){if(r&1&&(i(0,"div",62)(1,"div",63),C(2,"i",64),o(),i(3,"h4",12),n(4,"\xA1Pago aprobado!"),o(),i(5,"p",65),n(6,"Su transacci\xF3n ha sido procesada exitosamente"),o(),i(7,"div",66)(8,"div",67)(9,"div",68)(10,"div",69)(11,"div",70)(12,"strong"),n(13,"Orden:"),o()(),i(14,"div",70),n(15),o(),i(16,"div",70)(17,"strong"),n(18,"Monto:"),o()(),i(19,"div",70),n(20),b(21,"number"),o(),i(22,"div",70)(23,"strong"),n(24,"Fecha:"),o()(),i(25,"div",70),n(26),b(27,"date"),o(),i(28,"div",70)(29,"strong"),n(30,"Estado:"),o()(),i(31,"div",70)(32,"span",71),n(33,"Aprobado"),o()()()()()()()),r&2){let e=s();c(15),g(e.numeroOrden),c(5),y("$",A(21,3,e.monto,"1.0-0"),""),c(6),g(A(27,6,e.fechaTransaccion,"dd/MM/yyyy HH:mm"))}}function Ke(r,t){if(r&1){let e=S();i(0,"div",62)(1,"div",72),C(2,"i",73),o(),i(3,"h4",74),n(4,"Pago rechazado"),o(),i(5,"p",65),n(6,"Su transacci\xF3n no pudo ser procesada"),o(),i(7,"div",75)(8,"button",76),_("click",function(){p(e);let a=s();return u(a.reintentar())}),C(9,"i",77),n(10," Reintentar "),o(),i(11,"button",78),_("click",function(){p(e);let a=s();return u(a.cancelarPago())}),n(12," Cancelar "),o()()()}}var oe=class r{constructor(t){this.router=t}monto;numeroOrden;pagoCompletado=new ge;estadoPago="inicial";numeroTarjeta="";mesExpiracion="";anoExpiracion="";cvv="";nombreTitular="";tiempoRestante=0;progreso=0;intervaloTiempo;intervaloProgreso;fechaTransaccion=new Date;ngOnInit(){this.numeroTarjeta="4532 1234 5678 9012",this.mesExpiracion="12",this.anoExpiracion="2025",this.cvv="123",this.nombreTitular="JUAN PEREZ"}iniciarPago(){if(!this.validarDatos()){ie.default.fire({title:"Datos incompletos",text:"Por favor, complete todos los campos correctamente.",icon:"warning",confirmButtonText:"Entendido",confirmButtonColor:"#ffc107"});return}this.estadoPago="procesando",this.tiempoRestante=5,this.progreso=0,this.intervaloTiempo=setInterval(()=>{this.tiempoRestante--,this.tiempoRestante<=0&&this.finalizarPago()},1e3),this.intervaloProgreso=setInterval(()=>{this.progreso+=2,this.progreso>=100&&(this.progreso=100,clearInterval(this.intervaloProgreso))},100)}finalizarPago(){clearInterval(this.intervaloTiempo),clearInterval(this.intervaloProgreso),this.progreso=100,this.fechaTransaccion=new Date,Math.random()>.2?(this.estadoPago="completado",setTimeout(()=>{this.pagoCompletado.emit(!0)},2e3)):this.estadoPago="error"}reintentar(){this.estadoPago="inicial",this.tiempoRestante=0,this.progreso=0}cancelarPago(){ie.default.fire({title:"\xBFCancelar pago?",text:"Se cancelar\xE1 el proceso de pago actual",icon:"question",showCancelButton:!0,confirmButtonColor:"#dc3545",cancelButtonColor:"#6c757d",confirmButtonText:"S\xED, cancelar",cancelButtonText:"Continuar pago",reverseButtons:!0}).then(t=>{t.isConfirmed&&(this.intervaloTiempo&&clearInterval(this.intervaloTiempo),this.intervaloProgreso&&clearInterval(this.intervaloProgreso),ie.default.fire({title:"Pago cancelado",text:"El proceso de pago ha sido cancelado",icon:"info",timer:2e3,showConfirmButton:!1,timerProgressBar:!0}),this.pagoCompletado.emit(!1))})}validarDatos(){return this.numeroTarjeta.length>=16&&this.mesExpiracion.length===2&&this.anoExpiracion.length===4&&this.cvv.length>=3&&this.nombreTitular.length>0}formatearTarjeta(){let t=this.numeroTarjeta.replace(/\s+/g,"").replace(/[^0-9]/gi,"");t=t.substring(0,16);let e=t.match(/\d{4,16}/g),l=e&&e[0]||"",a=[];for(let d=0,T=l.length;d<T;d+=4)a.push(l.substring(d,d+4));a.length?this.numeroTarjeta=a.join(" "):this.numeroTarjeta=t}static \u0275fac=function(e){return new(e||r)(w(W))};static \u0275cmp=D({type:r,selectors:[["app-simular-pago"]],inputs:{monto:"monto",numeroOrden:"numeroOrden"},outputs:{pagoCompletado:"pagoCompletado"},decls:10,vars:4,consts:[[1,"transbank-simulator"],[1,"transbank-header"],[1,"d-flex","align-items-center","justify-content-center"],["src","assets/images/transbank-logo.png","alt","Transbank","onerror","this.style.display='none'",1,"transbank-logo","me-3"],[1,"mb-0","text-white"],["class","payment-form",4,"ngIf"],["class","text-center",4,"ngIf"],["class","text-center py-5",4,"ngIf"],[1,"payment-form"],[1,"row","mb-4"],[1,"col-md-6"],[1,"mb-1"],[1,"text-success"],[1,"mb-0"],[1,"security-info"],[1,"d-flex","align-items-center","mb-2"],[1,"fas","fa-shield-alt","text-success","me-2"],[1,"d-flex","align-items-center"],[1,"fas","fa-lock","text-success","me-2"],[3,"ngSubmit"],[1,"row"],[1,"col-md-6","mb-3"],["for","numeroTarjeta",1,"form-label"],["type","text","id","numeroTarjeta","name","numeroTarjeta","placeholder","0000 0000 0000 0000","maxlength","19","required","",1,"form-control",3,"ngModelChange","input","ngModel"],["for","nombreTitular",1,"form-label"],["type","text","id","nombreTitular","name","nombreTitular","placeholder","Como aparece en la tarjeta","required","",1,"form-control",2,"text-transform","uppercase",3,"ngModelChange","ngModel"],[1,"col-md-4","mb-3"],["for","mesExpiracion",1,"form-label"],["id","mesExpiracion","name","mesExpiracion","required","",1,"form-select",3,"ngModelChange","ngModel"],["value",""],["value","01"],["value","02"],["value","03"],["value","04"],["value","05"],["value","06"],["value","07"],["value","08"],["value","09"],["value","10"],["value","11"],["value","12"],["for","anoExpiracion",1,"form-label"],["id","anoExpiracion","name","anoExpiracion","required","",1,"form-select",3,"ngModelChange","ngModel"],["value","2024"],["value","2025"],["value","2026"],["value","2027"],["value","2028"],["value","2029"],["for","cvv",1,"form-label"],["type","password","id","cvv","name","cvv","placeholder","123","maxlength","4","required","",1,"form-control",3,"ngModelChange","ngModel"],[1,"text-center","mt-4"],["type","button",1,"btn","btn-secondary","me-3",3,"click"],["type","submit",1,"btn","btn-primary","btn-lg"],[1,"fas","fa-credit-card","me-2"],[1,"text-center"],["role","status",1,"spinner-border","text-primary","mb-3"],[1,"visually-hidden"],[1,"progress","mb-3",2,"height","25px"],["role","progressbar","aria-valuemin","0","aria-valuemax","100",1,"progress-bar","progress-bar-striped","progress-bar-animated","bg-success"],[1,"btn","btn-danger",3,"click"],[1,"text-center","py-5"],[1,"success-icon","mb-3"],[1,"fas","fa-check-circle","text-success",2,"font-size","4rem"],[1,"text-muted"],[1,"transaction-details","mt-4"],[1,"card"],[1,"card-body"],[1,"row","text-start"],[1,"col-6"],[1,"badge","bg-success"],[1,"error-icon","mb-3"],[1,"fas","fa-times-circle","text-danger",2,"font-size","4rem"],[1,"text-danger"],[1,"mt-4"],["type","button",1,"btn","btn-primary","me-3",3,"click"],[1,"fas","fa-redo","me-2"],["type","button",1,"btn","btn-secondary",3,"click"]],template:function(e,l){e&1&&(i(0,"div",0)(1,"div",1)(2,"div",2),C(3,"img",3),i(4,"h4",4),n(5,"Webpay Plus"),o()()(),f(6,$e,99,14,"div",5)(7,Ye,13,5,"div",6)(8,Je,34,9,"div",7)(9,Ke,13,0,"div",7),o()),e&2&&(c(6),m("ngIf",l.estadoPago==="inicial"),c(),m("ngIf",l.estadoPago==="procesando"),c(),m("ngIf",l.estadoPago==="completado"),c(),m("ngIf",l.estadoPago==="error"))},dependencies:[B,V,Se,be,X,Y,K,Z,z,J,q,H,Q,Ie,$,G],styles:[".transbank-simulator[_ngcontent-%COMP%]{max-width:600px;margin:0 auto}.transbank-header[_ngcontent-%COMP%]{background:linear-gradient(135deg,#1e3a8a,#3b82f6);padding:1rem;border-radius:8px 8px 0 0;margin:-1rem -1rem 2rem;border-bottom:3px solid #e5e7eb}.transbank-logo[_ngcontent-%COMP%]{max-height:30px;filter:brightness(0) invert(1)}.payment-form[_ngcontent-%COMP%]{padding:0 1rem}.security-info[_ngcontent-%COMP%]{background-color:#f8f9fa;padding:1rem;border-radius:6px;border-left:4px solid #10b981}.security-info[_ngcontent-%COMP%]   small[_ngcontent-%COMP%]{color:#6b7280;font-weight:500}.form-label[_ngcontent-%COMP%]{font-weight:600;color:#374151;margin-bottom:.5rem}.form-control[_ngcontent-%COMP%], .form-select[_ngcontent-%COMP%]{border:2px solid #e5e7eb;border-radius:6px;padding:.75rem;transition:all .2s ease}.form-control[_ngcontent-%COMP%]:focus, .form-select[_ngcontent-%COMP%]:focus{border-color:#3b82f6;box-shadow:0 0 0 3px #3b82f61a}.btn-primary[_ngcontent-%COMP%]{background:linear-gradient(135deg,#1e3a8a,#3b82f6);border:none;padding:.75rem 2rem;border-radius:6px;font-weight:600;transition:all .2s ease}.btn-primary[_ngcontent-%COMP%]:hover{transform:translateY(-1px);box-shadow:0 4px 12px #3b82f64d}.spinner-border[_ngcontent-%COMP%]{width:3rem;height:3rem}.progress[_ngcontent-%COMP%]{height:8px;border-radius:4px;background-color:#e5e7eb}.progress-bar[_ngcontent-%COMP%]{background:linear-gradient(90deg,#10b981,#059669);border-radius:4px}.success-icon[_ngcontent-%COMP%], .error-icon[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_scaleIn .5s ease-out}@keyframes _ngcontent-%COMP%_scaleIn{0%{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}.transaction-details[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]{border:none;background-color:#f8f9fa;border-radius:8px}.transaction-details[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]{padding:1.5rem}.transaction-details[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{padding:.25rem 0}.badge[_ngcontent-%COMP%]{font-size:.75rem;padding:.25rem .5rem}@media (max-width: 768px){.transbank-simulator[_ngcontent-%COMP%]{margin:0 -15px}.payment-form[_ngcontent-%COMP%]{padding:0 15px}.transbank-header[_ngcontent-%COMP%]{margin:-15px -15px 2rem}}"]})};var I=se(Te());var ne=class r{constructor(t){this.http=t}baseUrl=`${F.apiUrl}`;getRegiones(){return this.http.get(`${this.baseUrl}/regiones`)}getComunasPorRegion(t){return this.http.get(`${this.baseUrl}/comunas/region/${t}`)}static \u0275fac=function(e){return new(e||r)(k(j))};static \u0275prov=O({token:r,factory:r.\u0275fac,providedIn:"root"})};function Xe(r,t){r&1&&(i(0,"span"),n(1,"Seleccionar Cantidad"),o())}function et(r,t){r&1&&(i(0,"span"),n(1,"Resumen de Productos"),o())}function tt(r,t){r&1&&(i(0,"span"),n(1,"Datos de Entrega"),o())}function it(r,t){r&1&&(i(0,"span"),n(1,"Confirmar Pago"),o())}function ot(r,t){r&1&&C(0,"span")}function nt(r,t){if(r&1&&(i(0,"div",26)(1,"div",27),C(2,"i",28),n(3),o()()),r&2){let e=s(4);c(3),y(" Has alcanzado el stock m\xE1ximo disponible (",e.getStockDisponible()," unidades) ")}}function rt(r,t){if(r&1){let e=S();i(0,"div",11)(1,"div",12),C(2,"img",13),o(),i(3,"div",14)(4,"h4"),n(5),o(),i(6,"p",15),n(7),o(),i(8,"p",16),n(9),b(10,"conversor"),o(),i(11,"div",17)(12,"div",18)(13,"label",19),n(14,"Cantidad:"),o()(),i(15,"div",18)(16,"div",20)(17,"button",21),_("click",function(){p(e);let a=s(3);return u(a.disminuirCantidad())}),n(18," - "),o(),i(19,"input",22),x("ngModelChange",function(a){p(e);let d=s(3);return h(d.cantidad,a)||(d.cantidad=a),u(a)}),_("ngModelChange",function(){p(e);let a=s(3);return u(a.actualizarCantidad())}),o(),i(20,"button",21),_("click",function(){p(e);let a=s(3);return u(a.aumentarCantidad())}),n(21," + "),o()()()(),f(22,nt,4,1,"div",23),i(23,"div",24)(24,"h5"),n(25,"Subtotal: "),i(26,"span",25),n(27),b(28,"conversor"),o()()()()()}if(r&2){let e=s(3);c(2),m("src",e.compra.productos[0].producto.imagen,U)("alt",e.compra.productos[0].producto.nombre),c(3),g(e.compra.productos[0].producto.nombre),c(2),g(e.compra.productos[0].producto.descripcion),c(2),y("",M(10,12,e.getPrecioActual(e.compra.productos[0].producto))," c/u "),c(8),m("disabled",e.cantidad<=1),c(2),v("ngModel",e.cantidad),m("min",1)("max",e.getStockDisponible()),c(),m("disabled",e.cantidad>=e.getStockDisponible()||e.getStockDisponible()===0),c(2),m("ngIf",e.mostrarAvisoStock()),c(5),g(M(28,14,e.compra.subtotal))}}function at(r,t){if(r&1&&(i(0,"tr")(1,"td")(2,"strong"),n(3),o(),C(4,"br"),i(5,"small",15),n(6),o()(),i(7,"td"),n(8),b(9,"conversor"),o(),i(10,"td"),n(11),o(),i(12,"td"),n(13),b(14,"conversor"),o()()),r&2){let e=t.$implicit,l=s(4);c(3),g(e.producto.nombre),c(3),g(e.producto.descripcion),c(2),g(M(9,5,l.getPrecioActual(e.producto))),c(3),g(e.cantidad),c(2),g(M(14,7,l.getPrecioActual(e.producto)*e.cantidad))}}function ct(r,t){if(r&1&&(i(0,"div")(1,"div",29)(2,"table",30)(3,"thead")(4,"tr")(5,"th"),n(6,"Producto"),o(),i(7,"th"),n(8,"Precio"),o(),i(9,"th"),n(10,"Cantidad"),o(),i(11,"th"),n(12,"Subtotal"),o()()(),i(13,"tbody"),f(14,at,15,9,"tr",31),o()()(),i(15,"div",32)(16,"h5"),n(17,"Total: "),i(18,"span",25),n(19),b(20,"conversor"),o()()()()),r&2){let e=s(3);c(14),m("ngForOf",e.compra.productos),c(5),g(M(20,2,e.compra.subtotal))}}function lt(r,t){if(r&1&&(i(0,"div"),f(1,rt,29,16,"div",10)(2,ct,21,4,"div",5),o()),r&2){let e=s(2);c(),m("ngIf",!e.compra.esCompraCarrito),c(),m("ngIf",e.compra.esCompraCarrito)}}function st(r,t){r&1&&(i(0,"span"),n(1," (Principal)"),o())}function dt(r,t){if(r&1&&(i(0,"option",52),n(1),f(2,st,2,0,"span",5),o()),r&2){let e=t.$implicit,l=s(4);m("value",e.id),c(),he(" ",e.calle," ",e.numero,", ",l.getComunaNombre(e.comuna),", ",l.getRegionNombre(e.region)," "),c(),m("ngIf",e.esPrincipal)}}function mt(r,t){if(r&1){let e=S();i(0,"div",11)(1,"div",47)(2,"label",48),n(3,"Direcci\xF3n de entrega *"),o(),i(4,"select",49),x("ngModelChange",function(a){p(e);let d=s(3);return h(d.direccionSeleccionada,a)||(d.direccionSeleccionada=a),u(a)}),_("change",function(){p(e);let a=s(3);return u(a.onDireccionChange())}),f(5,dt,3,6,"option",50),i(6,"option",51),n(7,"Agregar nueva direcci\xF3n"),o()()()()}if(r&2){let e=s(3);c(4),v("ngModel",e.direccionSeleccionada),c(),m("ngForOf",e.direccionesUsuario)}}function pt(r,t){if(r&1&&(i(0,"option",52),n(1),o()),r&2){let e=t.$implicit;m("value",e.id),c(),g(e.nombre)}}function ut(r,t){if(r&1&&(i(0,"option",52),n(1),o()),r&2){let e=t.$implicit;m("value",e.id),c(),g(e.nombre)}}function gt(r,t){if(r&1){let e=S();i(0,"div")(1,"div",11)(2,"div",33)(3,"label",53),n(4,"Regi\xF3n *"),o(),i(5,"select",54),x("ngModelChange",function(a){p(e);let d=s(3);return h(d.datosCliente.region,a)||(d.datosCliente.region=a),u(a)}),_("change",function(){p(e);let a=s(3);return u(a.onRegionChange())}),i(6,"option",55),n(7,"Seleccionar regi\xF3n"),o(),f(8,pt,2,2,"option",50),o()(),i(9,"div",33)(10,"label",56),n(11,"Comuna *"),o(),i(12,"select",57),x("ngModelChange",function(a){p(e);let d=s(3);return h(d.datosCliente.comuna,a)||(d.datosCliente.comuna=a),u(a)}),i(13,"option",55),n(14,"Seleccionar comuna"),o(),f(15,ut,2,2,"option",50),o()()(),i(16,"div",11)(17,"div",58)(18,"label",59),n(19,"Calle *"),o(),i(20,"input",60),x("ngModelChange",function(a){p(e);let d=s(3);return h(d.datosCliente.calle,a)||(d.datosCliente.calle=a),u(a)}),o()(),i(21,"div",61)(22,"label",62),n(23,"N\xFAmero *"),o(),i(24,"input",63),x("ngModelChange",function(a){p(e);let d=s(3);return h(d.datosCliente.numero,a)||(d.datosCliente.numero=a),u(a)}),o()()()()}if(r&2){let e=s(3);c(5),v("ngModel",e.datosCliente.region),c(3),m("ngForOf",e.regiones),c(4),v("ngModel",e.datosCliente.comuna),m("disabled",e.comunaDisabled),c(3),m("ngForOf",e.comunas),c(5),v("ngModel",e.datosCliente.calle),c(4),v("ngModel",e.datosCliente.numero)}}function _t(r,t){if(r&1){let e=S();i(0,"div")(1,"form")(2,"div",11)(3,"div",33)(4,"label",34),n(5,"Nombre completo *"),o(),i(6,"input",35),x("ngModelChange",function(a){p(e);let d=s(2);return h(d.datosCliente.nombre,a)||(d.datosCliente.nombre=a),u(a)}),o()(),i(7,"div",33)(8,"label",36),n(9,"Email *"),o(),i(10,"input",37),x("ngModelChange",function(a){p(e);let d=s(2);return h(d.datosCliente.email,a)||(d.datosCliente.email=a),u(a)}),o()()(),i(11,"div",11)(12,"div",33)(13,"label",38),n(14,"Tel\xE9fono *"),o(),i(15,"input",39),x("ngModelChange",function(a){p(e);let d=s(2);return h(d.datosCliente.telefono,a)||(d.datosCliente.telefono=a),u(a)}),_("ngModelChange",function(){p(e);let a=s(2);return u(a.onTelefonoChange())}),o()(),C(16,"div",33),o(),f(17,mt,8,2,"div",10)(18,gt,25,7,"div",5),i(19,"div",40)(20,"label",41),n(21,"Tipo de despacho:"),o(),i(22,"div",42)(23,"input",43),x("ngModelChange",function(a){p(e);let d=s(2);return h(d.tipoDespacho,a)||(d.tipoDespacho=a),u(a)}),o(),i(24,"label",44),n(25),b(26,"conversor"),o()(),i(27,"div",42)(28,"input",45),x("ngModelChange",function(a){p(e);let d=s(2);return h(d.tipoDespacho,a)||(d.tipoDespacho=a),u(a)}),o(),i(29,"label",46),n(30," Retiro en tienda (Gratis) "),o()()()()()}if(r&2){let e=s(2);c(6),v("ngModel",e.datosCliente.nombre),m("readonly",e.datosUsuarioPrecompletados),c(4),v("ngModel",e.datosCliente.email),m("readonly",e.datosUsuarioPrecompletados),c(5),v("ngModel",e.datosCliente.telefono),c(2),m("ngIf",e.direccionesUsuario.length>0),c(),m("ngIf",e.mostrarFormularioDireccion||e.direccionesUsuario.length===0),c(5),v("ngModel",e.tipoDespacho),c(2),y(" Despacho a domicilio (+ ",M(26,10,e.valorDespacho),") "),c(3),v("ngModel",e.tipoDespacho)}}function ft(r,t){if(r&1&&(i(0,"div")(1,"div",70)(2,"span"),n(3),o(),i(4,"span"),n(5),b(6,"conversor"),o()()()),r&2){let e=s(3);c(3),ae("",e.compra.productos[0].producto.nombre," (x",e.compra.productos[0].cantidad,")"),c(2),g(M(6,3,e.compra.subtotal))}}function Ct(r,t){if(r&1&&(i(0,"div",72)(1,"span"),n(2),o(),i(3,"span"),n(4),b(5,"conversor"),o()()),r&2){let e=t.$implicit,l=s(4);c(2),ae("",e.producto.nombre," (x",e.cantidad,")"),c(2),g(M(5,3,l.getPrecioActual(e.producto)*e.cantidad))}}function vt(r,t){if(r&1&&(i(0,"div"),f(1,Ct,6,5,"div",71),o()),r&2){let e=s(3);c(),m("ngForOf",e.compra.productos)}}function ht(r,t){if(r&1&&(i(0,"div",70)(1,"span"),n(2,"Despacho"),o(),i(3,"span"),n(4),b(5,"conversor"),o()()),r&2){let e=s(3);c(4),g(M(5,1,e.costoDespacho))}}function xt(r,t){if(r&1&&(i(0,"div")(1,"div",64)(2,"div",65)(3,"h5"),n(4,"Resumen de compra"),o()(),i(5,"div",66),f(6,ft,7,5,"div",5)(7,vt,2,1,"div",5)(8,ht,6,3,"div",67),C(9,"hr"),i(10,"div",68)(11,"span"),n(12,"Total"),o(),i(13,"span",25),n(14),b(15,"conversor"),o()()()(),i(16,"div",69)(17,"h6"),n(18,"Datos de entrega:"),o(),i(19,"p")(20,"strong"),n(21),o(),C(22,"br"),n(23),C(24,"br"),n(25),C(26,"br"),n(27),o()()()),r&2){let e=s(2);c(6),m("ngIf",!e.compra.esCompraCarrito),c(),m("ngIf",e.compra.esCompraCarrito),c(),m("ngIf",e.tipoDespacho==="domicilio"),c(6),g(M(15,10,e.getTotal())),c(7),g(e.datosCliente.nombre),c(2),ve(" ",e.datosCliente.calle," ",e.datosCliente.numero,", ",e.getComunaNombrePorId(e.datosCliente.comuna),""),c(2),y(" ",e.getRegionNombrePorId(e.datosCliente.region),""),c(2),y(" ",e.datosCliente.telefono,"")}}function bt(r,t){if(r&1){let e=S();i(0,"div")(1,"app-simular-pago",73),_("pagoCompletado",function(a){p(e);let d=s(2);return u(d.onPagoCompletado(a))}),o()()}if(r&2){let e=s(2);c(),m("monto",e.getTotal())("numeroOrden",e.numeroOrden)}}function St(r,t){if(r&1&&(i(0,"div",9),f(1,lt,3,2,"div",5)(2,_t,31,12,"div",5)(3,xt,28,12,"div",5)(4,bt,2,2,"div",5),o()),r&2){let e=s();c(),m("ngIf",e.paso===1),c(),m("ngIf",e.paso===2),c(),m("ngIf",e.paso===3),c(),m("ngIf",e.paso===4)}}function yt(r,t){if(r&1){let e=S();i(0,"button",79),_("click",function(){p(e);let a=s(2);return u(a.volver())}),n(1,"Volver"),o()}}function Pt(r,t){if(r&1){let e=S();i(0,"button",80),_("click",function(){p(e);let a=s(2);return u(a.continuarPaso2())}),n(1,"Continuar"),o()}}function Mt(r,t){if(r&1){let e=S();i(0,"button",80),_("click",function(){p(e);let a=s(2);return u(a.continuarPaso3())}),n(1,"Continuar"),o()}}function wt(r,t){if(r&1){let e=S();i(0,"button",81),_("click",function(){p(e);let a=s(2);return u(a.procesarPago())}),n(1,"Pagar con Transbank"),o()}}function Et(r,t){if(r&1){let e=S();i(0,"div",74),f(1,yt,2,0,"button",75),i(2,"button",76),_("click",function(){p(e);let a=s();return u(a.cerrarModal())}),n(3,"Cancelar"),o(),f(4,Pt,2,0,"button",77)(5,Mt,2,0,"button",77)(6,wt,2,0,"button",78),o()}if(r&2){let e=s();c(),m("ngIf",e.paso>1&&e.paso!==2),c(3),m("ngIf",e.paso===1),c(),m("ngIf",e.paso===2),c(),m("ngIf",e.paso===3)}}var Be=class r{constructor(t,e,l,a,d,T){this.compraService=t;this.carritoService=e;this.authService=l;this.router=a;this.regionComunaService=d;this.pedidoService=T}compra=null;cantidad=1;paso=1;numeroOrden="";valorDespacho=3e3;datosCliente={nombre:"",email:"",telefono:"",calle:"",numero:"",comuna:"",region:""};tipoDespacho="domicilio";costoDespacho=3e3;datosUsuarioPrecompletados=!1;regiones=[];comunas=[];comunaDisabled=!0;direccionesUsuario=[];direccionSeleccionada="";mostrarFormularioDireccion=!1;telefonoModificado=!1;ngOnInit(){this.compraService.compraActual$.subscribe(t=>{t&&(this.compra=t,!t.esCompraCarrito&&t.productos.length>0&&(this.cantidad=t.productos[0].cantidad,this.cantidad>this.getStockDisponible()&&(this.cantidad=this.getStockDisponible(),this.actualizarCantidad())))}),this.compraService.limpiarFormulario$.subscribe(()=>{this.limpiarFormularioCliente()}),this.cargarRegiones()}cargarRegiones(){this.regionComunaService.getRegiones().subscribe({next:t=>{this.regiones=t},error:t=>{console.error("Error cargando regiones",t),this.regiones=[]}})}onRegionChange(){this.datosCliente.region?(this.comunaDisabled=!0,this.comunas=[],this.regionComunaService.getComunasPorRegion(Number(this.datosCliente.region)).subscribe({next:t=>{this.comunas=t,this.comunaDisabled=!1},error:t=>{console.error("Error cargando comunas",t),this.comunas=[],this.comunaDisabled=!0}})):(this.comunas=[],this.comunaDisabled=!0,this.datosCliente.comuna="")}getPrecioActual(t){return!t.precios||t.precios.length===0?0:t.precios[0].precio}getStockDisponible(){return this.compra&&!this.compra.esCompraCarrito&&this.compra.productos.length>0&&this.compra.productos[0].producto.stock||0}mostrarAvisoStock(){return!this.compra?.esCompraCarrito&&this.cantidad>=this.getStockDisponible()&&this.getStockDisponible()>0}aumentarCantidad(){this.cantidad<this.getStockDisponible()&&(this.cantidad++,this.actualizarCantidad())}disminuirCantidad(){this.cantidad>1&&(this.cantidad--,this.actualizarCantidad())}limpiarFormularioCliente(){this.datosCliente.telefono="",this.datosCliente.calle="",this.datosCliente.numero="",this.datosCliente.comuna="",this.datosCliente.region="",this.comunas=[],this.comunaDisabled=!0,this.tipoDespacho="domicilio",this.cantidad=1,this.paso=1,this.datosUsuarioPrecompletados=!1}limpiarFormularioCompleto(){this.datosCliente={nombre:"",email:"",telefono:"",calle:"",numero:"",comuna:"",region:""},this.tipoDespacho="domicilio",this.cantidad=1,this.paso=1,this.datosUsuarioPrecompletados=!1,this.comunas=[],this.comunaDisabled=!0}actualizarCantidad(){this.cantidad<1&&(this.cantidad=1),this.cantidad>this.getStockDisponible()&&(this.cantidad=this.getStockDisponible()),this.cantidad>=1&&this.compra&&!this.compra.esCompraCarrito&&this.compraService.actualizarCantidad(this.cantidad)}continuarPaso2(){if(!this.authService.isAuthenticated()){this.mostrarModalRegistro();return}this.precompletarDatosUsuario(),this.paso=2}precompletarDatosUsuario(){let t=this.authService.getCurrentUser();if(t){if(console.log("=== PRE-COMPLETANDO DATOS DEL USUARIO ==="),console.log("Usuario logueado:",t),this.datosCliente.nombre=t.nombre||"",this.datosCliente.email=t.email||"",this.datosUsuarioPrecompletados=!0,t.telefono&&(this.datosCliente.telefono=t.telefono),t.direcciones&&t.direcciones.length>0){this.direccionesUsuario=t.direcciones;let e=t.direcciones.find(l=>l.esPrincipal)||t.direcciones[0];this.direccionSeleccionada=e.id?.toString()||"",this.aplicarDireccionSeleccionada()}else this.direccionSeleccionada="nueva",this.mostrarFormularioDireccion=!0;console.log("Tel\xE9fono pre-completado:",this.datosCliente.telefono),console.log("Direcciones disponibles:",this.direccionesUsuario.length),console.log("datosUsuarioPrecompletados:",this.datosUsuarioPrecompletados),console.log("=========================================")}else console.log("No hay usuario logueado para pre-completar datos")}aplicarDireccionSeleccionada(){if(this.direccionSeleccionada==="nueva")this.mostrarFormularioDireccion=!0,this.limpiarCamposDireccion();else{this.mostrarFormularioDireccion=!1;let t=this.direccionesUsuario.find(e=>e.id?.toString()===this.direccionSeleccionada);t&&(this.datosCliente.calle=t.calle,this.datosCliente.numero=t.numero,typeof t.comuna=="string"?this.datosCliente.comuna=t.comuna:this.datosCliente.comuna=t.comuna.id.toString(),typeof t.region=="string"?this.datosCliente.region=t.region:(this.datosCliente.region=t.region.id.toString(),this.onRegionChange()))}}limpiarCamposDireccion(){this.datosCliente.calle="",this.datosCliente.numero="",this.datosCliente.comuna="",this.datosCliente.region="",this.comunas=[],this.comunaDisabled=!0}onDireccionChange(){this.aplicarDireccionSeleccionada()}onTelefonoChange(){this.telefonoModificado=!0}getComunaNombre(t){return typeof t=="string"?t:t.nombre}getRegionNombre(t){return typeof t=="string"?t:t.nombre}getRegionNombrePorId(t){if(!t||!this.regiones)return"";let e=this.regiones.find(l=>l.id.toString()===t);return e?e.nombre:t}getComunaNombrePorId(t){if(!t||!this.comunas)return"";let e=this.comunas.find(l=>l.id.toString()===t);return e?e.nombre:t}continuarPaso3(){this.validarDatosCliente()?this.actualizarDatosUsuario().then(()=>{console.log("=== DATOS DE ENTREGA CAPTURADOS ==="),console.log("Nombre completo:",this.datosCliente.nombre),console.log("Email:",this.datosCliente.email),console.log("Tel\xE9fono:",this.datosCliente.telefono),console.log("Regi\xF3n:",this.datosCliente.region),console.log("Comuna:",this.datosCliente.comuna),console.log("Calle:",this.datosCliente.calle),console.log("N\xFAmero:",this.datosCliente.numero),console.log("Direcci\xF3n completa:",`${this.datosCliente.calle} ${this.datosCliente.numero}, ${this.datosCliente.comuna}, ${this.datosCliente.region}`),console.log("Tipo de despacho:",this.tipoDespacho),console.log("Costo de despacho:",this.costoDespacho),console.log("Datos pre-completados del usuario:",this.datosUsuarioPrecompletados),console.log("Objeto completo datosCliente:",this.datosCliente),console.log("====================================="),this.compraService.actualizarDatosCliente(this.datosCliente),this.compraService.actualizarTipoDespacho(this.tipoDespacho),this.paso=3}).catch(t=>{console.error("Error actualizando datos del usuario:",t),I.default.fire({title:"Error",text:"No se pudieron actualizar los datos. Int\xE9ntelo nuevamente.",icon:"error",confirmButtonText:"Entendido"})}):I.default.fire({title:"Datos incompletos",text:"Por favor, complete todos los campos obligatorios.",icon:"warning",confirmButtonText:"Entendido",confirmButtonColor:"#ffc107"})}actualizarDatosUsuario(){return N(this,null,function*(){let t=this.authService.getCurrentUser();if(t)try{if((this.telefonoModificado||!t.telefono)&&(yield this.authService.updateDatosAdicionales({telefono:this.datosCliente.telefono}).toPromise()),this.direccionSeleccionada==="nueva"&&this.mostrarFormularioDireccion){let e=this.regiones.find(P=>P.id.toString()===this.datosCliente.region),l=this.comunas.find(P=>P.id.toString()===this.datosCliente.comuna);if(!e||!l)throw new Error("Regi\xF3n o comuna no encontrada");let a={calle:this.datosCliente.calle,numero:this.datosCliente.numero,region:e,comuna:l};console.log("Creando nueva direcci\xF3n:",a),yield this.authService.addDireccion(a).toPromise();let d=yield this.authService.getDireccionesUsuario().toPromise(),T=le(ce({},t),{direcciones:d});localStorage.setItem("ferremas_user",JSON.stringify(T)),this.direccionesUsuario=d||[]}}catch(e){throw console.error("Error detallado:",e),new Error("Error actualizando datos del usuario")}})}mostrarModalRegistro(){I.default.fire({title:"Inicia sesi\xF3n para continuar",text:"Para continuar con tu compra necesitas tener una cuenta en Ferremas",icon:"info",showCancelButton:!0,showDenyButton:!1,confirmButtonText:"Iniciar sesi\xF3n",cancelButtonText:"Registrarse",reverseButtons:!0,allowOutsideClick:!0,allowEscapeKey:!0,customClass:{container:"swal-auth-modal",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}}).then(t=>{this.cerrarModal(),t.isConfirmed?this.router.navigate(["/login"]):t.isDismissed&&t.dismiss===I.default.DismissReason.cancel&&this.router.navigate(["/registro"])})}procesarPago(){this.numeroOrden="ORD-"+Math.random().toString(36).substr(2,9).toUpperCase(),this.paso=4}volver(){this.paso>1&&this.paso--}cerrarModal(){this.paso=1,this.compraService.limpiarCompra();let t=document.getElementById("modalCompra");if(t){let e=window.bootstrap.Modal.getInstance(t);e&&e.hide()}}onPagoCompletado(t){return N(this,null,function*(){if(t)try{if(yield this.crearPedidoEnBackend(),this.compraService.getCompraActual()?.esCompraCarrito){let l=this.authService.getCurrentUser();this.carritoService.vaciarCarrito(l)}this.mostrarAlertaExito()}catch(e){console.error("Error creando pedido:",e),I.default.fire({title:"Pago procesado",text:"Su pago fue exitoso, pero hubo un problema registrando el pedido. Por favor contacte al soporte.",icon:"warning",confirmButtonText:"Entendido",confirmButtonColor:"#ffc107"}).then(()=>{if(this.compraService.getCompraActual()?.esCompraCarrito){let a=this.authService.getCurrentUser();this.carritoService.vaciarCarrito(a)}this.mostrarAlertaExito()})}else{I.default.fire({title:"Pago rechazado",text:"Su pago no pudo ser procesado. Volviendo al resumen de compra.",icon:"error",confirmButtonText:"Reintentar",confirmButtonColor:"#dc3545"}).then(()=>{this.paso=3});return}})}crearPedidoEnBackend(){return N(this,null,function*(){let t=this.authService.getCurrentUser(),e=this.compraService.getCompraActual();if(!t||!e)throw new Error("Usuario o compra no disponible");let l;if(this.direccionSeleccionada==="nueva"){let P=yield this.authService.getDireccionesUsuario().toPromise();if(!P||P.length===0)throw new Error("No se pudo obtener la direcci\xF3n reci\xE9n creada");l=P[P.length-1].id}else l=parseInt(this.direccionSeleccionada);let a=e.productos.map(P=>({producto:{id:P.producto.id},cantidad:P.cantidad,precioUnitario:P.producto.precios[0].precio,nombreProducto:P.producto.nombre})),d=this.mapearTipoEnvio(this.tipoDespacho),T={usuario:{id:t.id},direccionEntrega:{id:l},tipoEnvio:d,numeroOrden:this.numeroOrden,items:a};console.log("Creando pedido (formato backend):",T),yield this.pedidoService.crearPedido(T).toPromise(),console.log("Pedido creado exitosamente")})}mapearTipoEnvio(t){switch(t){case"domicilio":return"DOMICILIO";case"retiro":return"RETIRO_TIENDA";default:return"DOMICILIO"}}mostrarAlertaExito(){I.default.fire({title:"\xA1Compra exitosa!",text:"Su pago ha sido procesado correctamente",icon:"success",confirmButtonText:"Ir al inicio",confirmButtonColor:"#28a745",allowOutsideClick:!1,allowEscapeKey:!1}).then(t=>{console.log("Resultado SweetAlert:",t),this.limpiarTodosLosDatos(),this.cerrarModal(),t.isConfirmed&&(console.log("Navegando al home..."),this.router.navigate(["/"]).then(e=>{console.log("Navegaci\xF3n exitosa:",e)}).catch(e=>{console.error("Error en navegaci\xF3n:",e),window.location.href="/"}))})}validarDatosCliente(){return this.datosCliente.nombre.trim()!==""&&this.datosCliente.email.trim()!==""&&this.datosCliente.telefono.trim()!==""&&this.datosCliente.calle.trim()!==""&&this.datosCliente.numero.trim()!==""&&this.datosCliente.comuna.trim()!==""&&this.datosCliente.region.trim()!==""}getTotal(){if(!this.compra)return 0;let t=this.compra.subtotal;return this.tipoDespacho==="domicilio"&&(t+=this.costoDespacho),t}limpiarTodosLosDatos(){let t=this.authService.getCurrentUser();this.carritoService.vaciarCarrito(t),this.compraService.limpiarCompra()}static \u0275fac=function(e){return new(e||r)(w(te),w(L),w(ye),w(W),w(ne),w(Oe))};static \u0275cmp=D({type:r,selectors:[["app-modal-compra"]],decls:13,vars:7,consts:[["id","modalCompra","tabindex","-1","aria-labelledby","modalCompraLabel","aria-hidden","true",1,"modal","fade"],[1,"modal-dialog","modal-lg"],[1,"modal-content"],[1,"modal-header"],["id","modalCompraLabel",1,"modal-title"],[4,"ngIf"],["type","button","data-bs-dismiss","modal","aria-label","Close",1,"btn-close",3,"click"],["class","modal-body",4,"ngIf"],["class","modal-footer",4,"ngIf"],[1,"modal-body"],["class","row",4,"ngIf"],[1,"row"],[1,"col-md-4"],[1,"img-fluid","rounded",3,"src","alt"],[1,"col-md-8"],[1,"text-muted"],[1,"h5","text-success"],[1,"row","align-items-center","mt-4"],[1,"col-auto"],["for","cantidad",1,"form-label"],[1,"input-group","input-group-sm",2,"width","140px"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],["type","number","id","cantidad",1,"form-control","text-center",3,"ngModelChange","ngModel","min","max"],["class","mt-2",4,"ngIf"],[1,"mt-4"],[1,"text-success"],[1,"mt-2"],[1,"alert","alert-warning","alert-sm","mb-0"],[1,"fas","fa-exclamation-triangle","me-1"],[1,"table-responsive"],[1,"table","table-sm"],[4,"ngFor","ngForOf"],[1,"text-end"],[1,"col-md-6","mb-3"],["for","nombre",1,"form-label"],["type","text","id","nombre","name","nombre","required","",1,"form-control",3,"ngModelChange","ngModel","readonly"],["for","email",1,"form-label"],["type","email","id","email","name","email","required","",1,"form-control",3,"ngModelChange","ngModel","readonly"],["for","telefono",1,"form-label"],["type","tel","id","telefono","name","telefono","required","","placeholder","Ej: +56 9 1234 5678",1,"form-control",3,"ngModelChange","ngModel"],[1,"mb-3"],[1,"form-label"],[1,"form-check"],["type","radio","id","domicilio","name","tipoDespacho","value","domicilio",1,"form-check-input",3,"ngModelChange","ngModel"],["for","domicilio",1,"form-check-label"],["type","radio","id","retiro","name","tipoDespacho","value","retiro",1,"form-check-input",3,"ngModelChange","ngModel"],["for","retiro",1,"form-check-label"],[1,"col-12","mb-3"],["for","direccionSelector",1,"form-label"],["id","direccionSelector","name","direccionSelector",1,"form-select",3,"ngModelChange","change","ngModel"],[3,"value",4,"ngFor","ngForOf"],["value","nueva"],[3,"value"],["for","region",1,"form-label"],["id","region","name","region","required","",1,"form-select",3,"ngModelChange","change","ngModel"],["value",""],["for","comuna",1,"form-label"],["id","comuna","name","comuna","required","",1,"form-select",3,"ngModelChange","ngModel","disabled"],[1,"col-md-8","mb-3"],["for","calle",1,"form-label"],["type","text","id","calle","name","calle","required","","placeholder","Ej: Av. Libertador Bernardo O'Higgins",1,"form-control",3,"ngModelChange","ngModel"],[1,"col-md-4","mb-3"],["for","numero",1,"form-label"],["type","text","id","numero","name","numero","required","","placeholder","Ej: 1234",1,"form-control",3,"ngModelChange","ngModel"],[1,"card"],[1,"card-header"],[1,"card-body"],["class","d-flex justify-content-between",4,"ngIf"],[1,"d-flex","justify-content-between","h5"],[1,"mt-3"],[1,"d-flex","justify-content-between"],["class","d-flex justify-content-between mb-2",4,"ngFor","ngForOf"],[1,"d-flex","justify-content-between","mb-2"],[3,"pagoCompletado","monto","numeroOrden"],[1,"modal-footer"],["type","button","class","btn btn-secondary",3,"click",4,"ngIf"],["type","button","data-bs-dismiss","modal",1,"btn","btn-secondary",3,"click"],["type","button","class","btn btn-primary",3,"click",4,"ngIf"],["type","button","class","btn btn-success",3,"click",4,"ngIf"],["type","button",1,"btn","btn-secondary",3,"click"],["type","button",1,"btn","btn-primary",3,"click"],["type","button",1,"btn","btn-success",3,"click"]],template:function(e,l){e&1&&(i(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"h5",4),f(5,Xe,2,0,"span",5)(6,et,2,0,"span",5)(7,tt,2,0,"span",5)(8,it,2,0,"span",5)(9,ot,1,0,"span",5),o(),i(10,"button",6),_("click",function(){return l.cerrarModal()}),o()(),f(11,St,5,4,"div",7)(12,Et,7,4,"div",8),o()()()),e&2&&(c(5),m("ngIf",l.paso===1&&!(l.compra!=null&&l.compra.esCompraCarrito)),c(),m("ngIf",l.paso===1&&(l.compra==null?null:l.compra.esCompraCarrito)),c(),m("ngIf",l.paso===2),c(),m("ngIf",l.paso===3),c(),m("ngIf",l.paso===4),c(2),m("ngIf",l.compra),c(),m("ngIf",l.paso<4))},dependencies:[B,xe,V,X,Y,K,Z,z,Pe,J,Me,q,H,Q,Ee,we,$,G,oe,ee],styles:[".alert-sm[_ngcontent-%COMP%]{padding:.25rem .5rem;font-size:.75rem}.btn[_ngcontent-%COMP%]:disabled{opacity:.4!important;cursor:not-allowed!important;background-color:#e9ecef!important;border-color:#dee2e6!important;color:#6c757d!important}.input-group[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{flex:0 0 auto;min-width:38px}.input-group[_ngcontent-%COMP%]   .form-control.text-center[_ngcontent-%COMP%]{text-align:center}.input-group[_ngcontent-%COMP%]   input[type=number][_ngcontent-%COMP%]::-webkit-outer-spin-button, .input-group[_ngcontent-%COMP%]   input[type=number][_ngcontent-%COMP%]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}.input-group[_ngcontent-%COMP%]   input[type=number][_ngcontent-%COMP%]{-moz-appearance:textfield}"]})};var re=class r{constructor(t){this.http=t}baseUrl=`${F.apiUrl}`;getProductos(){return this.http.get(`${this.baseUrl}/productos`)}getProductoById(t){return this.http.get(`${this.baseUrl}/productos/${t}`)}getProductosByCategoria(t){return this.http.get(`${this.baseUrl}/productos/categoria/${t}`)}getProductosDestacados(){return this.http.get(`${this.baseUrl}/productos/destacados`)}getProductosByMarca(t){return this.http.get(`${this.baseUrl}/productos/marca/${t}`)}static \u0275fac=function(e){return new(e||r)(k(j))};static \u0275prov=O({token:r,factory:r.\u0275fac,providedIn:"root"})};var Ae=class r{constructor(t){this.productoApiService=t;this.cargarProductosIniciales()}productosSource=new de([]);productos$=this.productosSource.asObservable();cargarProductosIniciales(){console.log("Cargando productos desde backend..."),this.productoApiService.getProductos().pipe(E(t=>(console.log("Productos recibidos del backend:",t),t)),pe(t=>(console.error("Error cargando productos desde backend:",t),console.warn("Usando productos por defecto"),me([])))).subscribe(t=>{console.log("Productos cargados:",t),this.productosSource.next(t)})}getProductos(){return this.productos$}getProductosDestacados(){return this.productos$.pipe(E(t=>t.filter(e=>e.destacado&&!e.oculto)))}getProductosConDescuento(){return this.productos$.pipe(E(t=>t.filter(e=>e.descuento&&!e.oculto)))}getProductoPorId(t){return this.productos$.pipe(E(e=>e.find(l=>l.id===t)))}getProductosPorCategoria(t){return this.productos$.pipe(E(e=>e.filter(l=>l.categoriaId===t&&!l.oculto)))}getProductosPorMarca(t){return this.productos$.pipe(E(e=>e.filter(l=>l.marcaId===t&&!l.oculto)))}getMarcasDisponibles(){return this.productos$.pipe(E(t=>t.filter(l=>l.marca&&!l.oculto).map(l=>l.marca).filter((l,a,d)=>d.indexOf(l)===a).sort()))}buscarProductos(t){return this.productos$.pipe(E(e=>e.filter(l=>(l.nombre.toLowerCase().includes(t.toLowerCase())||l.descripcion.toLowerCase().includes(t.toLowerCase())||l.marca.toLowerCase().includes(t.toLowerCase()))&&!l.oculto)))}static \u0275fac=function(e){return new(e||r)(k(re))};static \u0275prov=O({token:r,factory:r.\u0275fac,providedIn:"root"})};export{ke as a,Be as b,Ae as c};
